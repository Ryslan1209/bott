// ===================================
// –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò
// ===================================

const TOKEN     = "8511091864:AAFohd5-zHav68ZEvZNF0nVucUmTRD9Gzbs"; 
const CHAT_ID   = "-1003440477465";                 // –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
const SHEET_NAME = "–õ–∏—Å—Ç1";

const TARGET_STATUS          = "–í–æ—Ä–æ–Ω–∫–∞ / –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞";   // –æ–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞
const TARGET_STATUS_INVOICE  = "–°—á–µ—Ç–∞ –Ω–∞ –∑–∞–∫–∞–∑";              // –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

// ID —Ç–µ–º –≤ –≥—Ä—É–ø–ø–µ
const TOPIC_PAYMENT_RECEIVED  = 195;  // ¬´–û–±—ä–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç—É (–æ–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞)¬ª
const TOPIC_INVOICE_FOR_ORDER = 173;  // ¬´–°—á–µ—Ç–∞ –Ω–∞ –∑–∞–∫–∞–∑¬ª
const TOPIC_PAID_INVOICES     = 207;  // ¬´–°—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É¬ª

// –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
const COL_INDEX = {
  DEAL_ID: 0, STATUS: 2, MANAGER: 10, BRAND: 5,
  CLIENT_NAME: 34, CLIENT_PHONE: 35, CLIENT_ADDRESS: 36,
  DOOR_MANUFACTURER: 37, DISCOUNT: 38, INSTALL_COST: 39, DELIVERY_COST: 40,
  PREPAY_SUM: 23, PREPAY_DATE: 16, FULL_KP_SUM: 21, ADDITIONAL_SALES: 25
};

// ===================================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
// ===================================

function getCellValue(d, i) {
  return d && i < d.length && d[i] !== null && d[i] !== undefined
    ? String(d[i]).trim()
    : "";
}

function formatMoney(a) {
  let n = Number(String(a).replace(/\s/g,'').replace(',','.'));
  return isNaN(n)
    ? "0"
    : Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function formatDate(d) {
  if (!d) return "–Ω–µ —É–∫–∞–∑–∞–Ω–∞";
  try {
    const date = new Date(d);
    return isNaN(date)
      ? String(d)
      : `${date.getDate().toString().padStart(2,'0')}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getFullYear()}`;
  } catch {
    return String(d);
  }
}

// ===================================
// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –Ω—É–∂–Ω—É—é —Ç–µ–º—É
// ===================================

function sendToTopic(text, topicId, keyboard = null) {
  const payload = {
    chat_id: CHAT_ID,
    message_thread_id: topicId,
    text: text,
    parse_mode: "HTML",
    disable_web_page_preview: true
  };
  if (keyboard) payload.reply_markup = JSON.stringify(keyboard);

  UrlFetchApp.fetch("https://api.telegram.org/bot" + TOKEN + "/sendMessage", {
    method: "post",
    payload: payload,
    muteHttpExceptions: true
  });
}

// ===================================
// –ö—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ message_id
// ===================================

function getPrev(dealId, suffix = "") {
  const c = PropertiesService.getScriptProperties().getProperty("cache" + suffix);
  return c ? JSON.parse(c)[dealId] || "" : "";
}

function savePrev(dealId, status, suffix = "") {
  let c = PropertiesService.getScriptProperties().getProperty("cache" + suffix) || "{}";
  c = JSON.parse(c);
  c[dealId] = status;
  PropertiesService.getScriptProperties().setProperty("cache" + suffix, JSON.stringify(c));
}

// –ö—ç—à message_id —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–µ–º–µ "–°—á–µ—Ç–∞ –Ω–∞ –∑–∞–∫–∞–∑"
function getInvoiceMessageId(dealId) {
  const cache = PropertiesService.getScriptProperties().getProperty("invoiceMessageCache");
  return cache ? JSON.parse(cache)[dealId] || null : null;
}

function saveInvoiceMessageId(dealId, messageId) {
  let cache = PropertiesService.getScriptProperties().getProperty("invoiceMessageCache") || "{}";
  cache = JSON.parse(cache);
  cache[dealId] = messageId;
  PropertiesService.getScriptProperties().setProperty("invoiceMessageCache", JSON.stringify(cache));
}

// –ö—ç—à message_id –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Ç–µ–º–µ 207
function getPaidMessageId(dealId) {
  const cache = PropertiesService.getScriptProperties().getProperty("paidMessageCache");
  return cache ? JSON.parse(cache)[dealId] || null : null;
}

function savePaidMessageId(dealId, messageId) {
  let cache = PropertiesService.getScriptProperties().getProperty("paidMessageCache") || "{}";
  cache = JSON.parse(cache);
  cache[dealId] = messageId;
  PropertiesService.getScriptProperties().setProperty("paidMessageCache", JSON.stringify(cache));
}

// ===================================
// 1. –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ ‚Üí –≤ —Ç–µ–º—É 195
// ===================================

function createBuhMessage(data, dealId) {
  const brand        = getCellValue(data, COL_INDEX.BRAND);
  const manufacturer = getCellValue(data, COL_INDEX.DOOR_MANUFACTURER);
  const client       = getCellValue(data, COL_INDEX.CLIENT_NAME);
  const phone        = getCellValue(data, COL_INDEX.CLIENT_PHONE);
  const address      = getCellValue(data, COL_INDEX.CLIENT_ADDRESS);
  const discount     = getCellValue(data, COL_INDEX.DISCOUNT);
  const install      = formatMoney(data[COL_INDEX.INSTALL_COST] || 0);
  const delivery     = formatMoney(data[COL_INDEX.DELIVERY_COST] || 0);
  const total        = formatMoney((Number(data[COL_INDEX.FULL_KP_SUM] || 0) + Number(data[COL_INDEX.ADDITIONAL_SALES] || 0)));
  const paid         = formatMoney(data[COL_INDEX.PREPAY_SUM] || 0);
  const paidDate     = formatDate(data[COL_INDEX.PREPAY_DATE]);

  let msg = `<b>–ù–û–í–ê–Ø –û–ü–õ–ê–ß–ï–ù–ù–ê–Ø –°–î–ï–õ–ö–ê</b>\n\n`;
  msg += `ID: <code>${dealId}</code>\n`;
  msg += `–ë—Ä–µ–Ω–¥: ${brand || "-"}\n`;
  msg += `–ó–∞–∫–∞–∑—á–∏–∫: ${client || "-"}\n`;
  msg += `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone || "-"}\n`;
  msg += `–ê–¥—Ä–µ—Å: ${address || "-"}\n`;
  msg += `${manufacturer || "-"}\n`;
  if (discount) msg += `–°–∫–∏–¥–∫–∞: ${discount}\n`;
  msg += `–°–º–µ—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${total}\n`;
  msg += `–û–ø–ª–∞—á–µ–Ω–æ: ${paid}`;
  if (paidDate !== "–Ω–µ —É–∫–∞–∑–∞–Ω–∞") msg += ` (–ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –°–±–µ—Ä –æ—Ç ${paidDate})`;
  msg += `\n–ú–æ–Ω—Ç–∞–∂: ${install}\n`;
  msg += `–î–æ—Å—Ç–∞–≤–∫–∞: ${delivery}`;
  return msg;
}

// ===================================
// 2. –°—á–µ—Ç–∞ –Ω–∞ –∑–∞–∫–∞–∑ ‚Üí —Ç–µ–º–∞ 173 + –∫–Ω–æ–ø–∫–∏
// ===================================

function createInvoiceMessage(data, dealId) {
  const manager      = getCellValue(data, COL_INDEX.MANAGER) || "–Ω–µ —É–∫–∞–∑–∞–Ω";
  const brand        = getCellValue(data, COL_INDEX.BRAND) || "-";
  const manufacturer = getCellValue(data, COL_INDEX.DOOR_MANUFACTURER) || "-";
  const total        = formatMoney((Number(data[COL_INDEX.FULL_KP_SUM] || 0) + Number(data[COL_INDEX.ADDITIONAL_SALES] || 0)));
  const filesLink    = `https://477658f.amocrm.ru/leads/detail/${dealId}?tab_id=files`;

  const msg = `<b>–ù–æ–≤—ã–π —Å—á—ë—Ç –Ω–∞ –∑–∞–∫–∞–∑!</b>\n\n` +
              `ID: <code>${dealId}</code>\n` +
              `–ú–µ–Ω–µ–¥–∂–µ—Ä: ${manager}\n` +
              `–ë—Ä–µ–Ω–¥: ${brand}\n` +
              `–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: ${manufacturer}\n` +
              `–°—É–º–º–∞: ${total} ‚ÇΩ\n\n` +
              `<a href="${filesLink}">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª—ã –≤ —Å–¥–µ–ª–∫–µ</a>\n\n` +
              `–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å?`;

  const keyboard = {
    inline_keyboard: [
      [{ text: "–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑",    callback_data: `approve_${dealId}` }],
      [{ text: "–û—Ç–∫–∞–∑–∞—Ç—å (—Å –ø—Ä–∏—á–∏–Ω–æ–π)", callback_data: `reject_${dealId}` }]
    ]
  };

  return { text: msg, keyboard: keyboard };
}

// –ö–∞—Ä—Ç–æ—á–∫–∞, —Å–æ–∑–¥–∞–≤–∞–µ–º–∞—è –≤ —Ç–µ–º–µ 207 –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
function createPaidInvoiceCard(data, dealId) {
  const manager      = getCellValue(data, COL_INDEX.MANAGER) || "–Ω–µ —É–∫–∞–∑–∞–Ω";
  const client       = getCellValue(data, COL_INDEX.CLIENT_NAME) || "-";
  const phone        = getCellValue(data, COL_INDEX.CLIENT_PHONE) || "-";
  const address      = getCellValue(data, COL_INDEX.CLIENT_ADDRESS) || "-";
  const manufacturer = getCellValue(data, COL_INDEX.DOOR_MANUFACTURER) || "-";
  const total        = formatMoney((Number(data[COL_INDEX.FULL_KP_SUM] || 0) + Number(data[COL_INDEX.ADDITIONAL_SALES] || 0)));
  const filesLink    = `https://477658f.amocrm.ru/leads/detail/${dealId}?tab_id=files`;

  return `<b>–°–ß–Å–¢ –ù–ê –û–ü–õ–ê–¢–£ ‚Äî –ó–ê–ö–ê–ó –°–û–ì–õ–ê–°–û–í–ê–ù</b>\n\n` +
         `ID: <code>${dealId}</code>\n` +
         `–ú–µ–Ω–µ–¥–∂–µ—Ä: ${manager}\n` +
         `–ó–∞–∫–∞–∑—á–∏–∫: ${client}\n` +
         `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n` +
         `–ê–¥—Ä–µ—Å: ${address}\n` +
         `–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: ${manufacturer}\n` +
         `–°—É–º–º–∞: ${total} ‚ÇΩ\n\n` +
         `<a href="${filesLink}">–û–¢–ö–†–´–¢–¨ –§–ê–ô–õ–´ –í –°–î–ï–õ–ö–ï</a>\n\n` +
         `<b>–ù–û–ú–ï–†–ê –°–ß–Å–¢–û–í –û–¢ –§–ê–ë–†–ò–ö</b>\–Ω–ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–ø–∏—Å–∞–Ω–æ\n\n` +
         `<i>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —è —Å–æ–±–µ—Ä—É –≤—Å–µ –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–æ–≤ —Å—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</i>`;
}

// ===================================
// –û—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ç–∞–±–ª–∏—Ü—ã
// ===================================

function installedOnEdit(e) {
  if (!e || e.changeType !== "EDIT") return;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) return;

  const ranges = e.source.getActiveRangeList()?.getRanges() || [];
  if (ranges.length === 0) return;

  const rows = new Set();
  ranges.forEach(r => {
    for (let i = r.getRow(); i <= r.getLastRow(); i++) {
      if (i >= 2) rows.add(i);
    }
  });

  rows.forEach(rowNum => {
    const data   = sheet.getRange(rowNum, 1, 1, 50).getValues()[0];
    const dealId = getCellValue(data, COL_INDEX.DEAL_ID);
    if (!dealId) return;

    const status = getCellValue(data, COL_INDEX.STATUS);

    // 1. –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞
    if (status === TARGET_STATUS && getPrev(dealId) !== status) {
      sendToTopic(createBuhMessage(data, dealId), TOPIC_PAYMENT_RECEIVED);
      savePrev(dealId, status);
    }

    // 2. –°—á–µ—Ç–∞ –Ω–∞ –∑–∞–∫–∞–∑
    if (status === TARGET_STATUS_INVOICE && getPrev(dealId, "_invoice") !== status) {
      const msg = createInvoiceMessage(data, dealId);

      const payload = {
        chat_id: CHAT_ID,
        message_thread_id: TOPIC_INVOICE_FOR_ORDER,
        text: msg.text,
        parse_mode: "HTML",
        disable_web_page_preview: true,
        reply_markup: JSON.stringify(msg.keyboard)
      };

      const response = UrlFetchApp.fetch("https://api.telegram.org/bot" + TOKEN + "/sendMessage", {
        method: "post",
        payload: payload,
        muteHttpExceptions: true
      });

      const result = JSON.parse(response.getContentText());
      if (result.ok) {
        saveInvoiceMessageId(dealId, result.result.message_id);
      }

      savePrev(dealId, status, "_invoice");
    }
  });
}

// ===================================
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –≤—Ä—É—á–Ω—É—é)
// ===================================

function setupAll() {
  ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));
  ScriptApp.newTrigger("installedOnEdit")
    .forSpreadsheet(SpreadsheetApp.getActive())
    .onChange()
    .create();
}

// ===================================
// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∫–Ω–æ–ø–æ–∫
// ===================================

function handleCallbackQuery(cb) {
  const dataStr = cb.data || "";
  if (!dataStr || !dataStr.includes("_")) return;

  const parts  = dataStr.split("_");
  const action = parts[0];
  const dealId = parts[1];

  const messageId = getInvoiceMessageId(dealId);
  if (!messageId) return;

  let editText = "";
  if (action === "approve") {
    editText = `–°–û–ì–õ–ê–°–û–í–ê–ù–û ‚úÖ\n\n–ó–∞–∫–∞–∑ –ø–æ —Å–¥–µ–ª–∫–µ ${dealId} —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω –∏ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ ¬´–°—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É¬ª`;

    // –ü–µ—Ä–µ–Ω–æ—Å –≤ —Ç–µ–º—É 207
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (sheet) {
      const allRows = sheet.getDataRange().getValues();
      let foundRow  = null;
      for (let row of allRows) {
        if (String(row[COL_INDEX.DEAL_ID]).trim() === dealId) {
          foundRow = row;
          break;
        }
      }

      if (foundRow) {
        const cardText = createPaidInvoiceCard(foundRow, dealId);

        const payload = {
          chat_id: CHAT_ID,
          message_thread_id: TOPIC_PAID_INVOICES,
          text: cardText,
          parse_mode: "HTML",
          disable_web_page_preview: true
        };

        const resp = UrlFetchApp.fetch("https://api.telegram.org/bot" + TOKEN + "/sendMessage", {
          method: "post",
          payload: payload,
          muteHttpExceptions: true
        });

        const json = JSON.parse(resp.getContentText());
        if (json.ok) {
          savePaidMessageId(dealId, json.result.message_id);
        }
      }
    }

  } else if (action === "reject") {
    editText = `–û–¢–ö–ê–ó–ê–ù–û ‚ùå\n\n–ó–∞–∫–∞–∑ –ø–æ —Å–¥–µ–ª–∫–µ ${dealId} –æ—Ç–∫–ª–æ–Ω—ë–Ω.\n–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.`;
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–º–µ 173
  UrlFetchApp.fetch("https://api.telegram.org/bot" + TOKEN + "/editMessageText", {
    method: "post",
    payload: JSON.stringify({
      chat_id: CHAT_ID,
      message_thread_id: TOPIC_INVOICE_FOR_ORDER,
      message_id: messageId,
      text: editText,
      parse_mode: "HTML"
    }),
    contentType: "application/json",
    muteHttpExceptions: true
  });

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∫–Ω–æ–ø–∫—É
  UrlFetchApp.fetch("https://api.telegram.org/bot" + TOKEN + "/answerCallbackQuery", {
    method: "post",
    payload: JSON.stringify({ callback_query_id: cb.id }),
    contentType: "application/json",
    muteHttpExceptions: true
  });
}

// ===================================
// –ò—Å—Ç–æ—Ä–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—á–µ—Ç–æ–≤ (–∫—ç—à)
// ===================================

function getOrdersHistory(dealId) {
  const hist = PropertiesService.getScriptProperties().getProperty("orders_" + dealId);
  if (hist) {
    try {
      return JSON.parse(hist);
    } catch (e) {
      Logger.log(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–¥–µ–ª–∫–∏ ${dealId}: ${e.toString()}`);
      return [];
    }
  }
  return [];
}

function addToOrdersHistory(dealId, text) {
  let history = getOrdersHistory(dealId);
  const today = new Date().toLocaleDateString('ru-RU');
  history.push({ date: today, text: text.trim() });
  PropertiesService.getScriptProperties().setProperty("orders_" + dealId, JSON.stringify(history));
}

function buildPaidCardText(dealId, baseData) {
  const history      = getOrdersHistory(dealId);
  const client       = getCellValue(baseData, COL_INDEX.CLIENT_NAME) || "-";
  const phone        = getCellValue(baseData, COL_INDEX.CLIENT_PHONE) || "-";
  const address      = getCellValue(baseData, COL_INDEX.CLIENT_ADDRESS) || "-";
  const manufacturer = getCellValue(baseData, COL_INDEX.DOOR_MANUFACTURER) || "-";
  const total        = formatMoney((Number(baseData[COL_INDEX.FULL_KP_SUM] || 0) + Number(baseData[COL_INDEX.ADDITIONAL_SALES] || 0)));
  const filesLink    = `https://477658f.amocrm.ru/leads/detail/${dealId}?tab_id=files`;

  let ordersText = history.length === 0 ? "–ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–ø–∏—Å–∞–Ω–æ" : "";

  history.forEach(entry => {
    ordersText += `\n<b>${entry.date}</b>\n${entry.text.replace(/\n/g, "\n")}`;
  });

  return `<b>–°–ß–Å–¢ –ù–ê –û–ü–õ–ê–¢–£ ‚Äî –ó–ê–ö–ê–ó –°–û–ì–õ–ê–°–û–í–ê–ù</b>\n\n` +
         `ID: <code>${dealId}</code>\n` +
         `–ó–∞–∫–∞–∑—á–∏–∫: ${client}\n` +
         `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n` +
         `–ê–¥—Ä–µ—Å: ${address}\n` +
         `–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: ${manufacturer}\n` +
         `–°—É–º–º–∞: ${total} ‚ÇΩ\n\n` +
         `<a href="${filesLink}">–û–¢–ö–†–´–¢–¨ –§–ê–ô–õ–´ –í –°–î–ï–õ–ö–ï</a>\n\n` +
         `<b>–ù–û–ú–ï–†–ê –°–ß–Å–¢–û–í –û–¢ –§–ê–ë–†–ò–ö</b>\n${ordersText}\n\n` +
         `<i>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –≤—Å—ë –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</i>`;
}

// ===================================
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Ç–µ–º–µ 207
// ===================================

function handleReplyInPaidTopic(update) {
  try {
    const replyMsg = update.message;
    if (!replyMsg || !replyMsg.reply_to_message || !replyMsg.message_thread_id) return false;

    const repliedMsg = replyMsg.reply_to_message;
    Logger.log(`–°–æ–æ–±—â–µ–Ω–∏–µ-–æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω–æ –≤ —Ç–µ–º–µ: ${replyMsg.message_thread_id}`);

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º—É
    if (String(replyMsg.message_thread_id) !== String(TOPIC_PAID_INVOICES)) {
      Logger.log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ–º—ã: ${replyMsg.message_thread_id}. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ${TOPIC_PAID_INVOICES}.`);
      return false;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –Ω–∞—à—É –∫–∞—Ä—Ç–æ—á–∫—É
    const repliedText = (repliedMsg.text || repliedMsg.caption || "");
    if (!repliedText.includes("–°–ß–Å–¢ –ù–ê –û–ü–õ–ê–¢–£")) {
      Logger.log("‚ùå –û—Ç–≤–µ—Ç –Ω–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É '–°–ß–Å–¢ –ù–ê –û–ü–õ–ê–¢–£'.");
      return false;
    }

    // 3. –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å–¥–µ–ª–∫–∏
    const match = repliedText.match(/ID:\s*(\d+)/);
    if (!match) {
      Logger.log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ ID —Å–¥–µ–ª–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏.");
      Logger.log("–¢–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏: " + repliedText);
      return false;
    }

    const dealId  = match[1];
    const userText = replyMsg.text || "";
    if (!userText.trim()) return true;

    Logger.log(`‚úÖ ID –°–¥–µ–ª–∫–∏ –Ω–∞–π–¥–µ–Ω: ${dealId}. –¢–µ–∫—Å—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${userText}`);

    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    addToOrdersHistory(dealId, userText);

    // 5. –ò—â–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    let rowData = null;
    if (sheet) {
      const dealIds = sheet.getRange("A2:A" + sheet.getLastRow()).getValues();
      const rowNum  = dealIds.findIndex(r => String(r[0]).trim() === dealId) + 2;
      if (rowNum >= 2) {
        rowData = sheet.getRange(rowNum, 1, 1, 50).getValues()[0];
      }
    }

    if (!rowData) {
      Logger.log(`‚ùå –î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏ ${dealId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ.`);
      return true;
    }

    // 6. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    const newText = buildPaidCardText(dealId, rowData);
    UrlFetchApp.fetch("https://api.telegram.org/bot" + TOKEN + "/editMessageText", {
      method: "post",
      payload: JSON.stringify({
        chat_id: CHAT_ID,
        message_thread_id: TOPIC_PAID_INVOICES,
        message_id: repliedMsg.message_id,
        text: newText,
        parse_mode: "HTML",
        disable_web_page_preview: true
      }),
      contentType: "application/json",
      muteHttpExceptions: true
    });

    Logger.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–¥–µ–ª–∫–∏ ${dealId} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.`);
    return true;

  } catch (e) {
    Logger.log("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ handleReplyInPaidTopic: " + e.toString());
    return false;
  }
}

// ===================================
// Webhook –¥–ª—è Telegram (–µ–¥–∏–Ω—ã–π doPost)
// ===================================

function doPost(e) {
  if (!e || !e.postData || !e.postData.contents) {
    return ContentService.textOutput("ok");
  }

  try {
    const update = JSON.parse(e.postData.contents);
    Logger.log("üîî –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + JSON.stringify(update));

    if (update.callback_query) {
      Logger.log("‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Callback Query.");
      handleCallbackQuery(update.callback_query);
    }

    if (update.message) {
      Logger.log("üìß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.");
      handleReplyInPaidTopic(update);
    }

  } catch (err) {
    Logger.log("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ doPost: " + err);
  }

  return ContentService.textOutput("ok");
}
